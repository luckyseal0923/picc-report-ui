<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>PICC å¾…é ç´„æ¸…å–®</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
               "Noto Sans TC", Arial, sans-serif;
  background: #fff7ed;
  margin: 0;
  padding: 20px;
}

h2 {
  margin-bottom: 8px;
  color: #92400e;
}

.hint {
  font-size: 14px;
  color: #7c2d12;
  margin-bottom: 16px;
}

.card {
  background: #ffffff;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 16px;
  border-left: 6px solid #f59e0b;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.card-inner {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.name {
  font-size: 18px;
  font-weight: 700;
}

.meta {
  font-size: 14px;
  color: #444;
  line-height: 1.5;
  word-break: break-all; /* âœ… ä¸æˆªæ–·ç—…æ­·è™Ÿ */
}

.taskid {
  margin-top: 4px;
  font-size: 12px;
  color: #9ca3af;
}

.action {
  display: flex;
  gap: 10px;
}

select {
  flex: 1;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 14px;
}

.btn {
  padding: 10px 14px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-size: 15px;
  background: #f59e0b;
  color: #fff;
  font-weight: 700;
  white-space: nowrap;
}

.btn:disabled {
  background: #d1d5db;
  cursor: not-allowed;
}

.empty {
  color: #92400e;
  font-size: 15px;
  margin-top: 20px;
}

.error {
  color: #b91c1c;
  font-weight: 700;
  margin-top: 20px;
}
</style>
</head>

<body>

<h2>âš ï¸ PICC å¾…é ç´„æ¸…å–®</h2>
<div class="hint">
ä»¥ä¸‹æ¡ˆä»¶å°šæœªè¢«æ¥å–®ï¼Œè«‹é¸æ“‡æ–½æ‰“äººå¾Œé»é¸ã€Œé ç´„æ–½æ‰“ã€ã€‚
</div>

<div id="msg"></div>
<div id="list"></div>

<script>
const API_LIST = "https://chihwei.app.n8n.cloud/webhook/unclaimed-list/booking";
const API_BOOK = "https://chihwei.app.n8n.cloud/webhook/booking";

const OPERATORS = [
  { id: "gong_bairong", name: "é¾”æŸæ¦•" },
  { id: "chang_chihwei", name: "å¼µæ™ºç¶­" },
  { id: "chen_weichi", name: "é™³ç‘‹çª" },
  { id: "chuang_dongen", name: "èŠæ±æ©" },
  { id: "chen_boan", name: "é™³æŸå®‰" }
];

const $ = id => document.getElementById(id);
const safe = v => v ?? "";

function setMsg(type, text) {
  const el = $("msg");
  el.className = type || "";
  el.textContent = text || "";
}

async function loadList() {
  $("list").innerHTML = "";
  setMsg("", "");

  try {
    const res = await fetch(API_LIST, { cache: "no-store" });
    const data = await res.json();

    const rows = data.filter(r => r.status === "å¾…é ç´„");
    if (!rows.length) {
      setMsg("empty", "ğŸ“­ ç›®å‰æ²’æœ‰å¾…é ç´„æ¡ˆä»¶");
      return;
    }

    rows.forEach(item => $("list").appendChild(renderCard(item)));
  } catch {
    setMsg("error", "âŒ ç„¡æ³•è¼‰å…¥å¾…é ç´„æ¸…å–®");
  }
}

function renderCard(item) {
  const card = document.createElement("div");
  card.className = "card";

  const select = document.createElement("select");

  // âœ… placeholder
  const placeholder = document.createElement("option");
  placeholder.textContent = "è«‹é¸æ“‡æ–½æ‰“äºº";
  placeholder.disabled = true;
  placeholder.selected = true;
  select.appendChild(placeholder);

  OPERATORS.forEach(op => {
    const opt = document.createElement("option");
    opt.value = op.id;
    opt.textContent = op.name;
    select.appendChild(opt);
  });

  const btn = document.createElement("button");
  btn.className = "btn";
  btn.textContent = "é ç´„æ–½æ‰“";

  btn.onclick = async () => {
    if (select.selectedIndex === 0) {
      alert("è«‹å…ˆé¸æ“‡æ–½æ‰“äºº");
      return;
    }

    const operator = OPERATORS[select.selectedIndex - 1];
    btn.disabled = true;
    btn.textContent = "è™•ç†ä¸­â€¦";

    try {
      const res = await fetch(API_BOOK, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          taskId: item.taskId,
          operatorId: operator.id,
          operatorName: operator.name
        })
      });

      if (!res.ok) throw new Error();
      card.remove();
    } catch {
      alert("âŒ é ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      btn.disabled = false;
      btn.textContent = "é ç´„æ–½æ‰“";
    }
  };

  card.innerHTML = `
    <div class="card-inner">
      <div>
        <div class="name">${safe(item.name)}</div>
        <div class="meta">
          åºŠè™Ÿ ${safe(item.bedNo)} ï½œ ç—…æ­·è™Ÿ ${safe(item.mrn)}
        </div>
        <div class="taskid">ä»»å‹™ç·¨è™Ÿï¼š${safe(item.taskId)}</div>
      </div>
      <div class="action"></div>
    </div>
  `;

  card.querySelector(".action").append(select, btn);
  return card;
}

loadList();
</script>

</body>
</html>
