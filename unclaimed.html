<script>
async function loadList() {
  setMsg("", "");
  $("list").innerHTML = "";

  try {
    const res = await fetch(API_LIST, { cache: "no-store" });
    const raw = await res.text();

    if (!res.ok) {
      throw new Error("HTTP " + res.status);
    }

    let data;
    try {
      data = JSON.parse(raw);
    } catch {
      throw new Error("å›å‚³ä¸æ˜¯ JSON");
    }

    if (!Array.isArray(data)) {
      throw new Error("API å›å‚³ä¸æ˜¯é™£åˆ—");
    }

    // âœ… åªé¡¯ç¤ºã€Œå¾…é ç´„ + å°šæœªæ¥å–®ã€
    const rows = data.filter(r =>
      safe(r.status) === "å¾…é ç´„" && !safe(r.claimedBy)
    );

    // âœ… é€™æ˜¯ã€Œæ­£å¸¸ç‹€æ…‹ã€ï¼Œä¸æ˜¯éŒ¯èª¤
    if (rows.length === 0) {
      setMsg("empty", "ğŸ“­ ç›®å‰æ²’æœ‰å¾…é ç´„æ¡ˆä»¶");
      return;
    }

    // âœ… æ­£å¸¸æ¸²æŸ“
    rows.forEach(item => {
      $("list").appendChild(renderCard(item));
    });

  } catch (err) {
    console.error(err);
    setMsg("error", "âŒ ç³»çµ±æš«æ™‚ç„¡æ³•è¼‰å…¥æ¸…å–®");
  }
}

loadList();
</script>
