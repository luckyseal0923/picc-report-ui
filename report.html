<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>PICC æ–½æ‰“å›å ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
                   "Segoe UI", "Noto Sans TC", Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 24px;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 640px;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    }

    h2 { margin: 0 0 16px; font-size: 22px; }
    h3 { margin: 0 0 12px; font-size: 18px; }

    .hint {
      font-size: 13px;
      color: #64748b;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .row { margin-bottom: 14px; }

    label {
      display: block;
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 6px;
      color: #334155;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      box-sizing: border-box;
    }

    textarea { min-height: 90px; resize: vertical; }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .readonly {
      background: #f1f5f9;
      font-weight: 700;
    }

    .btn {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      font-weight: 800;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
    }

    .btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }

    .danger {
      color: #b91c1c;
      font-size: 13px;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- =========================
       ä»»å‹™è³‡è¨Šï¼ˆreadonlyï¼‰
  ========================== -->
  <div class="card">
    <h2>ğŸ“Œ PICC æ–½æ‰“å›å ±</h2>
    <div class="hint">ä»¥ä¸‹ä»»å‹™è³‡è¨Šç”±ç³»çµ±å¸¶å…¥ï¼Œåƒ…ä¾›ç¢ºèªï¼Œç„¡æ³•ä¿®æ”¹ã€‚</div>

    <div class="row">
      <label>ä»»å‹™ç·¨è™Ÿï¼ˆtaskIdï¼‰</label>
      <input class="readonly" id="taskIdText" readonly />
    </div>

    <div class="grid2">
      <div class="row">
        <label>ç—…äººå§“å</label>
        <input class="readonly" id="name" readonly />
      </div>
      <div class="row">
        <label>åºŠè™Ÿ</label>
        <input class="readonly" id="bedNo" readonly />
      </div>
    </div>

    <div class="grid2">
      <div class="row">
        <label>MRN</label>
        <input class="readonly" id="mrn" readonly />
      </div>
      <div class="row">
        <label>æ¥å–®è€…</label>
        <input class="readonly" id="claimedBy" readonly />
      </div>
    </div>
  </div>

  <!-- =========================
       å›å ±å®Œæˆæç¤ºï¼ˆé è¨­éš±è—ï¼‰
  ========================== -->
  <div class="card" id="doneBox" style="display:none;">
    <div style="display:flex; align-items:center; gap:12px;">
      <div style="font-size:28px;">âœ…</div>
      <div style="flex:1;">
        <div style="font-size:18px; font-weight:800; margin-bottom:4px;">
          æ–½æ‰“å›å ±å·²å®Œæˆ
        </div>
        <div style="font-size:14px; color:#64748b;">
          æ­¤æ¡ˆä»¶å·²æ¨™è¨˜ç‚ºå®Œæˆï¼Œå¯è¿”å›å¾…æ–½æ‰“æ¸…å–®ã€‚
        </div>
      </div>
      <button
        type="button"
        onclick="goBackToList()"
        style="
          padding:10px 14px;
          border-radius:10px;
          border:none;
          background:#16a34a;
          color:#fff;
          font-weight:700;
          cursor:pointer;
        "
      >
        ğŸ”™ è¿”å›æ¸…å–®
      </button>
    </div>
  </div>

  <!-- =========================
       æ–½æ‰“å›å ±è¡¨å–®ï¼ˆâœ… å®Œæ•´ä¿ç•™ï¼‰
  ========================== -->
  <div class="card">
    <h3>ğŸ“ æ–½æ‰“å›å ±è³‡æ–™</h3>

    <form
      method="POST"
      action="https://chihwei.app.n8n.cloud/webhook/picc/report-submit?done=1"
    >
      <input type="hidden" name="taskId" id="taskIdInput" />
      <input type="hidden" name="status" value="å®Œæˆ" />

      <div class="grid2">
        <div class="row">
          <label>æ–½æ‰“äºº</label>
          <input id="operator" type="text" name="operator" required />
        </div>

        <div class="row">
          <label>æ”¾ç½®å›°é›£åº¦</label>
          <select name="difficulty" required>
            <option value="" disabled selected>è«‹é¸æ“‡</option>
            <option value="éå¸¸ç°¡å–®">éå¸¸ç°¡å–®</option>
            <option value="ç°¡å–®">ç°¡å–®</option>
            <option value="ä¸­ç­‰">ä¸­ç­‰</option>
            <option value="å›°é›£">å›°é›£</option>
            <option value="éå¸¸å›°é›£">éå¸¸å›°é›£</option>
          </select>
        </div>
      </div>

      <!-- âœ… ä½ æŒ‡å‡ºè¢«åˆªæ‰çš„æ¬„ä½ï¼šå®Œæ•´ä¿ç•™ -->
      <div class="grid2">
        <div class="row">
          <label>æ–½æ‰“ä½ç½®</label>
          <select name="insertionSite" required>
            <option value="" disabled selected>è«‹é¸æ“‡</option>
            <option value="å³ä¸Šè‡‚">å³ä¸Šè‡‚</option>
            <option value="å·¦ä¸Šè‡‚">å·¦ä¸Šè‡‚</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>

        <div class="row">
          <label>è¡€ç®¡</label>
          <select name="vein" required>
            <option value="" disabled selected>è«‹é¸æ“‡</option>
            <option value="Basilic">Basilic</option>
            <option value="Cephalic">Cephalic</option>
            <option value="Brachial">Brachial</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div class="row">
          <label>ç®¡è·¯é•·åº¦ï¼ˆcmï¼‰</label>
          <input type="number" step="0.1" name="catheterLength" required />
        </div>

        <div class="row">
          <label>ç®¡è·¯é¡å‹</label>
          <select name="catheterType" required>
            <option value="" disabled selected>è«‹é¸æ“‡</option>
            <option value="é›™è…” PICC">é›™è…” PICC</option>
            <option value="å–®è…” PICC">å–®è…” PICC</option>
          </select>
        </div>
      </div>

      <div class="row">
        <label>å‚™è¨»</label>
        <textarea name="remark" placeholder="è£œå……èªªæ˜ï¼ˆå¯ä¸å¡«ï¼‰"></textarea>
      </div>

      <button class="btn" type="submit" id="submitBtn">é€å‡ºæ–½æ‰“å›å ±</button>
      <div class="danger" id="errBox">âŒ æ‰¾ä¸åˆ° taskIdï¼Œè«‹ç”±å¾…æ–½æ‰“æ¸…å–®é€²å…¥ã€‚</div>
    </form>
  </div>

</div>

<script>
  // =========================
  // Step 1ï¼šåªæ”¹ã€Œå¸¶å…¥ä»»å‹™è³‡è¨Šã€
  // å…¶ä»–ç©©å®šåŠŸèƒ½ä¸€å¾‹ä¿ç•™
  // =========================
  const API_URL = "https://chihwei.appo.n8n.cloud/webhook/picc/task";
  const params = new URLSearchParams(window.location.search);

  const taskId = params.get("taskId");
  const operator = params.get("operator") || ""; // âœ… ä¿ç•™ä½ åŸæœ¬çš„åŠŸèƒ½ï¼ˆå¯å¸¶å…¥æ–½æ‰“äººï¼‰

  // å…ˆæŠŠ taskId å¡«ä¸Šï¼ˆå°±ç®— API é‚„æ²’å›ä¾†ä¹Ÿçœ‹å¾—åˆ°ï¼‰
  document.getElementById("taskIdText").value  = taskId || "æœªå¸¶å…¥";
  document.getElementById("taskIdInput").value = taskId || "";
  document.getElementById("operator").value    = operator;

  if (!taskId) {
    document.getElementById("errBox").style.display = "block";
    document.getElementById("submitBtn").disabled = true;
  } else {
    // âœ… æ–°å¢ï¼šç”¨ taskId å‘å¾Œç«¯æŠ“ä»»å‹™è³‡è¨Šï¼Œå¡«å…¥ readonly æ¬„ä½
    fetch(`${API_URL}?taskId=${encodeURIComponent(taskId)}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById("name").value      = data.name || "";
        document.getElementById("bedNo").value     = data.bedNo || "";
        document.getElementById("mrn").value       = data.mrn || "";
        document.getElementById("claimedBy").value = data.claimedBy || "";

        // double ä¿éšªï¼šå¾Œç«¯å›ä¾†çš„ taskId å„ªå…ˆ
        document.getElementById("taskIdText").value  = data.taskId || taskId;
        document.getElementById("taskIdInput").value = data.taskId || taskId;
      })
      .catch(() => {
        document.getElementById("errBox").style.display = "block";
        document.getElementById("submitBtn").disabled = true;
      });
  }

  // âœ… ä¿ç•™ä½ åŸæœ¬çš„å®Œæˆæç¤º
  if (params.get("done") === "1") {
    const box = document.getElementById("doneBox");
    if (box) box.style.display = "block";
  }

  // âœ… ä¿ç•™ä½ åŸæœ¬ hint çš„è¿”å›æ¸…å–®
  function goBackToList() {
    window.location.href =
      "https://luckyseal0923.github.io/picc-report-ui/list.html";
  }
</script>

</body>
</html>
