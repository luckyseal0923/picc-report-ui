<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PICC ä»»å‹™ç®¡ç†ï¼ˆå°ˆæ¥­ç·¨è¼¯ç‰ˆï¼‰</title>
<style>
  :root { --primary: #10B981; --bg: #f8fafc; --text: #334155; --border: #e2e8f0; }
  body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
  .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px; gap: 10px; }
  .filter-bar { background: white; padding: 15px; border-radius: 12px; border: 1px solid var(--border); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  
  .table-container { width: 100%; overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
  table { width: 100%; border-collapse: collapse; min-width: 1200px; }
  th { background: #f1f5f9; padding: 12px; font-size: 13px; text-align: left; color: #64748b; border-bottom: 2px solid var(--border); }
  td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }

  /* ç·¨è¼¯æ¨¡å¼æ¨£å¼ */
  .view-mode { display: inline-block; }
  .edit-mode { display: none; width: 90%; padding: 5px; border: 1px solid var(--primary); border-radius: 4px; }
  .editing .view-mode { display: none; }
  .editing .edit-mode { display: inline-block; }

  .btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: bold; }
  .btn-edit { background: #e2e8f0; color: #475569; }
  .btn-save { background: var(--primary); color: white; display: none; }
  .btn-del { background: #fee2e2; color: #b91c1c; }
  .editing .btn-save { display: inline-block; }
  .editing .btn-edit { display: none; }

  /* æ‰‹æ©Ÿç‰ˆ RWD è½‰å¡ç‰‡ */
  @media (max-width: 1000px) {
    .table-container { background: transparent; box-shadow: none; }
    table, thead, tbody, th, td, tr { display: block; }
    thead { display: none; }
    tr { background: white; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; padding: 15px; }
    td { display: flex; justify-content: space-between; padding: 8px 0; border: none; border-bottom: 1px dashed #eee; text-align: right; }
    td::before { content: attr(data-label); font-weight: bold; color: #64748b; text-align: left; }
    td:last-child { border: none; flex-direction: row; justify-content: center; gap: 10px; padding-top: 15px; }
  }
</style>
</head>
<body>

<div class="header">
  <h2>ğŸ“‹ PICC ä»»å‹™ç®¡ç†ç³»çµ±</h2>
  <div class="filter-bar">
    <input type="date" id="dateStart"> <span>è‡³</span> <input type="date" id="dateEnd">
    <button class="btn btn-primary" onclick="loadTasks()">æŸ¥è©¢å€é–“</button>
  </div>
</div>

<div class="table-container">
  <table id="taskTable">
    <thead>
      <tr>
        <th>èµ·å–®æ™‚é–“</th><th>ä»»å‹™ç·¨è™Ÿ</th><th>ç—…æ­·è™Ÿ</th><th>ç—…äºº/åºŠè™Ÿ</th><th>æ¥å–®/æ–½æ‰“</th>
        <th>å›°é›£åº¦</th><th>éƒ¨ä½/è¡€ç®¡</th><th>ç®¡è·¯è³‡è¨Š</th><th>å‚™è¨»</th><th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="taskBody"></tbody>
  </table>
</div>

<script>
const API_LIST = "https://chihwei-n8n.zeabur.app/webhook/admin/tasks";
const API_UPDATE = "https://chihwei-n8n.zeabur.app/webhook/admin/update-task";
const API_DELETE = "https://chihwei-n8n.zeabur.app/webhook/admin/delete-task";

// é è¨­æ—¥æœŸå€é–“ (è¿‘å…©å€‹æœˆ)
const now = new Date();
const twoMonthsAgo = new Date();
twoMonthsAgo.setMonth(now.getMonth() - 2);
document.getElementById('dateStart').value = twoMonthsAgo.toISOString().split('T')[0];
document.getElementById('dateEnd').value = now.toISOString().split('T')[0];

function loadTasks() {
  const start = document.getElementById('dateStart').value;
  const end = document.getElementById('dateEnd').value;
  
  fetch(`${API_LIST}?start=${start}&end=${end}`)
    .then(res => res.json())
    .then(renderTable);
}

function renderTable(data) {
  const tbody = document.getElementById("taskBody");
  tbody.innerHTML = data.map(row => `
    <tr id="tr-${row.task_id}">
      <td data-label="èµ·å–®æ™‚é–“">${row.createdAt.split('T')[0]}</td>
      <td data-label="ç·¨è™Ÿ"><b>${row.task_id}</b></td>
      <td data-label="MRN">${row.MRN}</td>
      <td data-label="ç—…äºº/åºŠè™Ÿ">
        ${row.patient_name}<br>
        <span class="view-mode">(${row.bed_no ?? 'æœªå¡«'})</span>
        <input class="edit-mode bed_no" value="${row.bed_no ?? ''}">
      </td>
      <td data-label="æ¥å–®/æ–½æ‰“">
        <span class="view-mode">${row.claimedBy ?? '-'}/${row.operator ?? '-'}</span>
        <div class="edit-mode">
            <input class="claimedBy" value="${row.claimedBy ?? ''}" placeholder="æ¥å–®">
            <input class="operator" value="${row.operator ?? ''}" placeholder="æ–½æ‰“">
        </div>
      </td>
      <td data-label="å›°é›£åº¦">
        <span class="view-mode">${row.difficulty}</span>
        <select class="edit-mode difficulty">
          <option value="ä¸€èˆ¬" ${row.difficulty==='ä¸€èˆ¬'?'selected':''}>ä¸€èˆ¬</option>
          <option value="å›°é›£" ${row.difficulty==='å›°é›£'?'selected':''}>å›°é›£</option>
        </select>
      </td>
      <td data-label="éƒ¨ä½/è¡€ç®¡">
        <span class="view-mode">${row.insertionSite ?? '-'}/${row.vein ?? '-'}</span>
        <div class="edit-mode">
            <input class="insertionSite" value="${row.insertionSite ?? ''}" placeholder="éƒ¨ä½">
            <input class="vein" value="${row.vein ?? ''}" placeholder="è¡€ç®¡">
        </div>
      </td>
      <td data-label="ç®¡è·¯è³‡è¨Š">
        <span class="view-mode">${row.catheterType ?? '-'}/${row.catheterLength ?? '-'}cm</span>
        <div class="edit-mode">
            <input class="catheterType" value="${row.catheterType ?? ''}" placeholder="ç¨®é¡">
            <input class="catheterLength" type="number" value="${row.catheterLength ?? ''}" placeholder="é•·åº¦">
        </div>
      </td>
      <td data-label="å‚™è¨»">
        <span class="view-mode">${row.remark ?? '-'}</span>
        <input class="edit-mode remark" value="${row.remark ?? ''}">
      </td>
      <td>
        <button class="btn btn-edit" onclick="toggleEdit('${row.task_id}')">ç·¨è¼¯</button>
        <button class="btn btn-save" onclick="saveRow('${row.task_id}')">å„²å­˜</button>
        <button class="btn btn-del" onclick="deleteRow('${row.task_id}')">åˆªé™¤</button>
      </td>
    </tr>
  `).join('');
}

function toggleEdit(id) {
  document.getElementById(`tr-${id}`).classList.add('editing');
}

function saveRow(id) {
  const tr = document.getElementById(`tr-${id}`);
  const payload = {
    task_id: id,
    bed_no: tr.querySelector(".bed_no").value,
    claimedBy: tr.querySelector(".claimedBy").value,
    operator: tr.querySelector(".operator").value,
    difficulty: tr.querySelector(".difficulty").value,
    insertionSite: tr.querySelector(".insertionSite").value,
    vein: tr.querySelector(".vein").value,
    catheterType: tr.querySelector(".catheterType").value,
    catheterLength: tr.querySelector(".catheterLength").value,
    remark: tr.querySelector(".remark").value
  };

  fetch(API_UPDATE, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  }).then(() => {
    alert("å„²å­˜æˆåŠŸ");
    tr.classList.remove('editing');
    loadTasks();
  });
}

function deleteRow(id) {
  if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ä»»å‹™å—ï¼Ÿ")) return;
  fetch(API_DELETE, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ task_id: id })
  }).then(() => {
    document.getElementById(`tr-${id}`).remove();
    alert("å·²åˆªé™¤");
  });
}

window.onload = loadTasks;
</script>
</body>
</html>
