<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PICC ä»»å‹™ç®¡ç†ç³»çµ± - Pro</title>
<style>
  :root { --primary: #10B981; --bg: #f8fafc; --text: #334155; --border: #e2e8f0; }
  body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
  .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px; gap: 10px; }
  .filter-bar { background: white; padding: 12px; border-radius: 10px; border: 1px solid var(--border); display: flex; gap: 10px; align-items: center; }
  
  .table-container { width: 100%; overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
  table { width: 100%; border-collapse: collapse; min-width: 1300px; }
  
  /* è¡¨é ­æ’åºæ¨£å¼ */
  th { background: #f1f5f9; padding: 14px; font-size: 13px; text-align: left; color: #1e293b; border-bottom: 2px solid var(--border); cursor: pointer; white-space: nowrap; position: relative; }
  th:hover { background: #e2e8f0; }
  th::after { content: ' â†•'; opacity: 0.3; font-size: 10px; }

  td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
  .view-mode { display: inline-block; }
  .edit-mode { display: none; width: 95%; padding: 6px; border: 1px solid var(--primary); border-radius: 4px; box-sizing: border-box; }
  .editing .view-mode { display: none; }
  .editing .edit-mode { display: block; }

  .btn { padding: 6px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: 0.2s; }
  .btn-edit { background: #f1f5f9; color: #475569; }
  .btn-save { background: var(--primary); color: white; display: none; }
  .btn-del { background: #fee2e2; color: #b91c1c; }
  .editing .btn-save { display: inline-block; }
  .editing .btn-edit { display: none; }

  @media (max-width: 1000px) {
    table, thead, tbody, th, td, tr { display: block; }
    thead { display: none; }
    tr { border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; padding: 10px; }
    td { display: flex; justify-content: space-between; padding: 10px 5px; border: none; border-bottom: 1px dashed #eee; text-align: right; }
    td::before { content: attr(data-label); font-weight: bold; color: #64748b; text-align: left; }
  }
</style>
</head>
<body>

<div class="header">
  <h2>ğŸ“‹ PICC ä»»å‹™ç®¡ç†ç³»çµ±</h2>
  <div class="filter-bar">
    <input type="date" id="dateStart"> <span>è‡³</span> <input type="date" id="dateEnd">
    <button class="btn btn-primary" style="background:var(--primary); color:white" onclick="loadTasks()">æŸ¥è©¢å€é–“</button>
  </div>
</div>

<div class="table-container">
  <table id="taskTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">èµ·å–®æ™‚é–“ / ä»»å‹™ç·¨è™Ÿ</th>
        <th onclick="sortTable(1)">ç—…äºº / ç—…æ­·è™Ÿ</th>
        <th onclick="sortTable(2)">åºŠè™Ÿ</th>
        <th onclick="sortTable(3)">æ¥å–®è€…</th>
        <th onclick="sortTable(4)">æ–½æ‰“è€…</th>
        <th onclick="sortTable(5)">ç®¡è·¯ (ç¨®é¡/é•·åº¦)</th>
        <th onclick="sortTable(6)">éƒ¨ä½ / è¡€ç®¡</th>
        <th onclick="sortTable(7)">æ–½æ‰“å›°é›£åº¦</th>
        <th onclick="sortTable(8)">å‚™è¨»</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="taskBody"></tbody>
  </table>
</div>

<script>
const API_LIST = "https://chihwei-n8n.zeabur.app/webhook/admin/tasks";
const API_UPDATE = "https://chihwei-n8n.zeabur.app/webhook/update-task";
const API_DELETE = "https://chihwei-n8n.zeabur.app/webhook/delete-task";

// é è¨­æ—¥æœŸå€é–“
const now = new Date();
const twoMonthsAgo = new Date();
twoMonthsAgo.setMonth(now.getMonth() - 2);
document.getElementById('dateStart').value = twoMonthsAgo.toISOString().split('T')[0];
document.getElementById('dateEnd').value = now.toISOString().split('T')[0];

function loadTasks() {
  const start = document.getElementById('dateStart').value;
  const end = document.getElementById('dateEnd').value;
  fetch(`${API_LIST}?start=${start}&end=${end}`)
    .then(res => res.json())
    .then(renderTable);
}

function renderTable(data) {
  const tbody = document.getElementById("taskBody");
  tbody.innerHTML = data.map(row => {
    // æ™‚é–“æ ¼å¼è™•ç†ï¼šYYYY-MM-DD HH:mm
    const timeStr = row.createdAt ? row.createdAt.replace('T',' ').substring(0, 16) : '-';
    return `
    <tr id="tr-${row.task_id}">
      <td data-label="èµ·å–®/ç·¨è™Ÿ">
        <span style="font-size:12px; color:#64748b">${timeStr}</span><br>
        <b>${row.task_id}</b>
      </td>
      <td data-label="ç—…äºº/ç—…æ­·è™Ÿ">
        <b>${row.patient_name}</b><br>
        <span style="font-size:12px; color:#64748b">MRN: ${row.MRN}</span>
      </td>
      <td data-label="åºŠè™Ÿ">
        <span class="view-mode">${row.bed_no ?? '-'}</span>
        <input class="edit-mode bed_no" value="${row.bed_no ?? ''}">
      </td>
      <td data-label="æ¥å–®è€…">
        <span class="view-mode">${row.claimedBy ?? '-'}</span>
        <input class="edit-mode claimedBy" value="${row.claimedBy ?? ''}">
      </td>
      <td data-label="æ–½æ‰“è€…">
        <span class="view-mode">${row.operator ?? '-'}</span>
        <input class="edit-mode operator" value="${row.operator ?? ''}">
      </td>
      <td data-label="ç®¡è·¯è³‡è¨Š">
        <span class="view-mode">${row.catheterType ?? '-'}/${row.catheterLength ?? '-'}cm</span>
        <div class="edit-mode">
          <input class="catheterType" value="${row.catheterType ?? ''}" placeholder="ç¨®é¡" style="margin-bottom:4px">
          <input class="catheterLength" type="number" value="${row.catheterLength ?? ''}" placeholder="é•·åº¦">
        </div>
      </td>
      <td data-label="éƒ¨ä½/è¡€ç®¡">
        <span class="view-mode">${row.insertionSite ?? '-'}/${row.vein ?? '-'}</span>
        <div class="edit-mode">
          <input class="insertionSite" value="${row.insertionSite ?? ''}" placeholder="éƒ¨ä½" style="margin-bottom:4px">
          <input class="vein" value="${row.vein ?? ''}" placeholder="è¡€ç®¡">
        </div>
      </td>
      <td data-label="å›°é›£åº¦">
        <span class="view-mode">${row.difficulty}</span>
        <select class="edit-mode difficulty">
          <option value="ä¸€èˆ¬" ${row.difficulty==='ä¸€èˆ¬'?'selected':''}>ä¸€èˆ¬</option>
          <option value="å›°é›£" ${row.difficulty==='å›°é›£'?'selected':''}>å›°é›£</option>
        </select>
      </td>
      <td data-label="å‚™è¨»">
        <span class="view-mode">${row.remark ?? '-'}</span>
        <textarea class="edit-mode remark" rows="2">${row.remark ?? ''}</textarea>
      </td>
      <td>
        <div style="display:flex; gap:5px">
          <button class="btn btn-edit" onclick="toggleEdit('${row.task_id}')">ç·¨è¼¯</button>
          <button class="btn btn-save" onclick="saveRow('${row.task_id}')">å„²å­˜</button>
          <button class="btn btn-del" onclick="deleteRow('${row.task_id}')">åˆªé™¤</button>
        </div>
      </td>
    </tr>
  `}).join('');
}

// æ’åºåŠŸèƒ½å¯¦ä½œ
function sortTable(n) {
  const table = document.getElementById("taskTable");
  let rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
  switching = true;
  dir = "asc"; 
  while (switching) {
    switching = false;
    rows = table.rows;
    for (i = 1; i < (rows.length - 1); i++) {
      shouldSwitch = false;
      x = rows[i].getElementsByTagName("TD")[n];
      y = rows[i + 1].getElementsByTagName("TD")[n];
      if (dir == "asc") {
        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
          shouldSwitch = true; break;
        }
      } else if (dir == "desc") {
        if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
          shouldSwitch = true; break;
        }
      }
    }
    if (shouldSwitch) {
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      switchcount ++;      
    } else {
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
}

function toggleEdit(id) { document.getElementById(`tr-${id}`).classList.add('editing'); }

function saveRow(id) {
  const tr = document.getElementById(`tr-${id}`);
  const payload = {
    task_id: id,
    bed_no: tr.querySelector(".bed_no").value,
    claimedBy: tr.querySelector(".claimedBy").value,
    operator: tr.querySelector(".operator").value,
    difficulty: tr.querySelector(".difficulty").value,
    insertionSite: tr.querySelector(".insertionSite").value,
    vein: tr.querySelector(".vein").value,
    catheterType: tr.querySelector(".catheterType").value,
    catheterLength: tr.querySelector(".catheterLength").value,
    remark: tr.querySelector(".remark").value
  };

  fetch(API_UPDATE, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  }).then(res => {
    if(res.ok) {
        alert("å„²å­˜æˆåŠŸ");
        tr.classList.remove('editing');
        loadTasks();
    }
  });
}

function deleteRow(id) {
  if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ä»»å‹™å—ï¼Ÿ")) return;
  fetch(API_DELETE, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ task_id: id })
  }).then(res => {
    if(res.ok) {
        document.getElementById(`tr-${id}`).remove();
        alert("å·²åˆªé™¤");
    }
  });
}

window.onload = loadTasks;
</script>
</body>
</html>
